<!DOCTYPE html>
<html lang="es">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>AMPA Futsal - LIVE</title>
    
    <link rel="manifest" href="manifest.json">
    <link rel="icon" type="image/png" href="icon.png">
    <meta name="theme-color" content="#1e293b">
    <meta name="apple-mobile-web-app-capable" content="yes">

    <link href="https://fonts.googleapis.com/css2?family=Montserrat:wght@400;600;700;800&display=swap" rel="stylesheet">
    <style>
        /* --- ESTILOS GENERALES --- */
        :root {
            --brand-dark: #1e293b; --brand-blue: #2563eb; 
            --bg-color: #f1f5f9; --card-bg: #ffffff;
            --text-main: #334155; --accent: #f59e0b;
            --whatsapp: #25d366; --danger: #ef4444;
            --disabled: #94a3b8; --gold: #fbbf24;
            --reserve: #f97316;
        }
        body { font-family: 'Montserrat', sans-serif; background-color: var(--bg-color); color: var(--text-main); margin: 0; padding: 0; display: flex; flex-direction: column; align-items: center; min-height: 100vh; }
        
        header { background-color: var(--brand-dark); width: 100%; padding: 20px 0; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); position: sticky; top: 0; z-index: 100; display: flex; flex-direction: column; justify-content: center; align-items: center; user-select: none; }
        h1 { text-align: center; color: white; font-size: 1.1rem; margin: 0; font-weight: 800; text-transform: uppercase; line-height: 1.2; cursor: pointer; }
        .match-date-display { color: var(--accent); font-size: 0.8rem; margin-top: 5px; font-weight: 600; text-transform: uppercase; letter-spacing: 1px; }
        
        .container { width: 90%; max-width: 600px; padding: 15px 0; padding-bottom: 60px; flex: 1; }
        
        /* SALUDO */
        #user-greeting { background: #fffbeb; border: 1px solid #fcd34d; color: #92400e; padding: 10px; border-radius: 8px; margin-bottom: 15px; text-align: center; font-weight: bold; font-size: 0.85rem; display: none; animation: fadeIn 0.5s; }

        /* TARJETA DE INFO DE PARTIDO */
        .match-info-card {
            background: white; border-radius: 12px; padding: 15px;
            text-align: center; box-shadow: 0 4px 10px rgba(0,0,0,0.05);
            margin-bottom: 20px; border: 1px solid #e2e8f0;
        }
        .res-date { font-weight: 800; font-size: 1rem; color: var(--brand-dark); text-transform: uppercase; margin-bottom: 5px; }
        .res-time { font-weight: 800; color: var(--brand-blue); font-size: 1.1rem; margin-bottom: 5px; display: block; }
        .res-location { font-size: 0.8rem; color: #64748b; display: flex; align-items: center; justify-content: center; gap: 5px; }

        /* ZONA DE JUEGO (CRONO) */
        .game-controls { background: #1e293b; color: white; border-radius: 12px; padding: 15px; margin-bottom: 20px; box-shadow: 0 4px 10px rgba(0,0,0,0.2); text-align: center; }
        
        .timer-display {
            font-family: 'Courier New', monospace; font-size: 3rem; font-weight: bold; color: #4ade80;
            background: #0f172a; padding: 10px; border-radius: 8px; border: 2px solid #334155;
            margin-bottom: 5px; letter-spacing: 2px; min-height: 80px; display: flex; align-items: center; justify-content: center;
        }
        .timer-display.last-minute { color: #fbbf24; border-color: #fbbf24; animation: pulseTimer 1s infinite; }
        .timer-display.finished { color: #ef4444; border-color: #ef4444; font-size: 1.8rem; line-height: 1; animation: blink 0.5s infinite; }
        .timer-status-text { font-size: 0.7rem; color: #94a3b8; margin-bottom: 10px; height: 15px; font-weight: bold; text-transform: uppercase; }
        
        .timer-btn-row { display: flex; gap: 10px; justify-content: center; margin-bottom: 15px; }
        .t-btn { padding: 8px 20px; border-radius: 20px; border: none; font-weight: bold; cursor: pointer; font-size: 0.9rem; width: 100px; }
        .t-start { background: #22c55e; color: white; }
        .t-stop { background: #ef4444; color: white; }
        .t-reset { background: #64748b; color: white; }

        /* MARCADOR */
        .scoreboard { display: flex; justify-content: space-around; background: #334155; padding: 10px; border-radius: 8px; margin-top: 10px; }
        .score-box { display: flex; flex-direction: column; align-items: center; gap: 5px; }
        .score-team { font-size: 0.7rem; font-weight: bold; text-transform: uppercase; }
        .score-val { font-size: 1.5rem; font-weight: bold; color: white; }
        .score-btn { background: rgba(255,255,255,0.2); border: none; color: white; width: 25px; height: 25px; border-radius: 50%; cursor: pointer; font-weight: bold; }
        .sb-blanco { color: #ffffff; } .sb-negro { color: #94a3b8; } .sb-rojo { color: #f87171; }

        /* BOT√ìN INSTALAR APP */
        .install-center { width: 100%; text-align: center; margin-bottom: 15px; }
        .install-app-btn {
            background: white; border: 1px solid #cbd5e1; color: #475569;
            padding: 6px 12px; border-radius: 20px; font-size: 0.7rem;
            font-weight: bold; cursor: pointer; display: inline-flex; align-items: center; gap: 5px;
            box-shadow: 0 2px 5px rgba(0,0,0,0.05); transition: all 0.2s;
        }
        .install-app-btn:hover { background: #f1f5f9; transform: translateY(-1px); }

        /* ADMIN ZONE */
        #admin-zone { display: none; background-color: #ffe4e6; border: 2px dashed #e11d48; padding: 15px; border-radius: 12px; margin-bottom: 20px; text-align: center; animation: slideDown 0.3s ease-out; box-shadow: 0 10px 25px rgba(0,0,0,0.1); }
        .admin-title { color: #e11d48; font-weight: 800; font-size: 0.9rem; margin-bottom: 10px; text-transform: uppercase; }
        .admin-btn { background-color: #e11d48; color: white; border: none; padding: 10px 15px; border-radius: 6px; font-size: 0.8rem; margin: 5px 0; cursor: pointer; font-weight: bold; width: 100%; }
        .admin-btn-blue { background-color: var(--brand-blue); }
        .admin-btn-dark { background-color: #334155; }
        .admin-btn-green { background-color: #16a34a; }
        .admin-btn-yellow { background-color: #eab308; color: #422006; }
        
        .pin-toggle-btn { width: 100%; padding: 10px; border-radius: 6px; font-weight: bold; cursor: pointer; border: 1px solid rgba(0,0,0,0.1); margin-bottom: 15px; font-size: 0.8rem; }
        .pin-on { background-color: #22c55e; color: white; }
        .pin-off { background-color: #ef4444; color: white; }

        .chip-list { display: flex; flex-wrap: wrap; gap: 5px; justify-content: center; margin-top: 5px; margin-bottom: 15px; padding-top: 5px; border-top: 1px solid #fca5a5; }
        .chip { background: white; border: 1px solid #ccc; color: #555; padding: 5px 10px; border-radius: 15px; font-size: 0.7rem; font-weight: bold; cursor: pointer; display: flex; align-items: center; gap: 5px; }
        .chip-reset { border-color: #eab308; color: #a16207; } .chip-reset:hover { background: #eab308; color: white; }
        .chip-ban { border-color: #ef4444; color: #ef4444; } .chip-ban.is-banned { background: #ef4444; color: white; text-decoration: line-through; }

        .new-player-form { background: white; padding: 10px; border-radius: 8px; margin-bottom: 15px; border: 1px solid #e2e8f0; display: flex; gap: 5px; align-items: center; }
        .new-player-form input { width: 60%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; }
        .new-player-form select { width: 30%; padding: 8px; border: 1px solid #ccc; border-radius: 4px; font-size: 0.8rem; }
        .new-player-btn { background: #16a34a; color: white; border: none; padding: 8px; border-radius: 4px; cursor: pointer; font-weight: bold; }

        .time-control { display: flex; gap: 10px; align-items: center; margin-bottom: 15px; background: white; padding: 10px; border-radius: 8px; }
        .time-control input { width: auto; margin: 0; padding: 8px; font-size: 1rem; border: 1px solid #ccc; }
        .time-control button { width: auto; margin: 0; padding: 8px 15px; font-size: 0.8rem; }

        /* BARRA ESTADO */
        .status-bar { background: white; padding: 15px 20px; border-radius: 12px; box-shadow: 0 2px 8px rgba(0,0,0,0.05); margin-bottom: 25px; }
        .status-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 5px; }
        .status-label { font-size: 0.8rem; font-weight: 800; color: #64748b; text-transform: uppercase; }
        .status-count { font-size: 1.5rem; font-weight: 800; color: var(--brand-dark); }
        .progress-track { width: 100%; height: 10px; background-color: #e2e8f0; border-radius: 5px; overflow: hidden; }
        .progress-fill { height: 100%; width: 0%; transition: width 0.5s ease, background-color 0.5s ease; }
        .countdown-text { text-align: right; font-size: 0.7rem; color: #ef4444; font-weight: bold; margin-top: 5px; font-family: monospace; }
        
        h3 { font-size: 0.95rem; color: var(--brand-dark); text-transform: uppercase; border-bottom: 2px solid #e2e8f0; padding-bottom: 8px; margin-top: 30px; }
        .player-group { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 12px; }
        
        .player-checkbox { position: relative; background: var(--card-bg); padding: 12px 15px; border-radius: 8px; border: 1px solid #e2e8f0; display: flex; align-items: center; cursor: pointer; transition: all 0.2s ease; font-size: 0.9rem; font-weight: 600; user-select: none; }
        .player-checkbox.selected { background-color: #eff6ff; border-color: var(--brand-blue); color: var(--brand-blue); box-shadow: 0 2px 4px rgba(37, 99, 235, 0.1); }
        .player-checkbox.reserve { background-color: #fff7ed; border-color: var(--reserve); color: var(--reserve); }
        .player-checkbox.banned { opacity: 0.5; background-color: #f1f5f9; cursor: not-allowed; border-color: #cbd5e1; }
        .player-checkbox.banned::after { content: '‚õî'; position: absolute; right: 10px; }
        
        .lock-icon { font-size: 0.8em; margin-left: auto; opacity: 0.6; }
        .player-checkbox.is-me { border: 2px solid var(--gold); background-color: #fffbeb; }
        .player-checkbox input { display: none; }
        .guest-label { border-style: dashed; flex-direction: column; align-items: flex-start; gap: 2px; }
        .guest-label .guest-name { display: flex; width: 100%; align-items: center; }
        .guest-label.selected { background-color: #fffbeb; border-color: var(--accent); color: #b45309; border-style: solid; }
        .invited-by { font-size: 0.6rem; color: #78350f; font-weight: normal; width: 100%; text-align: left; padding-left: 20px; }

        .order-badge { position: absolute; top: -8px; right: -8px; background: var(--brand-blue); color: white; font-size: 0.65rem; width: 20px; height: 20px; border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; box-shadow: 0 2px 4px rgba(0,0,0,0.2); transform: scale(0); transition: transform 0.2s; }
        .player-checkbox.selected .order-badge { transform: scale(1); }
        .player-checkbox.reserve .order-badge { background: var(--reserve); }

        .action-btn { width: 100%; background-color: var(--brand-dark); color: white; border: none; padding: 16px; font-size: 1rem; border-radius: 12px; margin-top: 40px; margin-bottom: 5px; cursor: pointer; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 12px rgba(30, 41, 59, 0.25); transition: all 0.2s; }
        .action-btn:active { transform: scale(0.98); }
        .action-btn:disabled { background-color: var(--disabled); cursor: not-allowed; box-shadow: none; transform: none; }

        .vote-btn { width: 100%; background-color: #fef08a; color: #854d0e; border: 1px solid #facc15; padding: 10px; font-size: 0.8rem; border-radius: 8px; font-weight: bold; cursor: pointer; margin-top: 5px; margin-bottom: 20px; display: none; }
        
        .notify-btn { background-color: #dcfce7; color: #166534; border: 1px solid #86efac; width: 100%; padding: 12px; border-radius: 8px; font-weight: bold; cursor: pointer; display: flex; align-items: center; justify-content: center; gap: 8px; margin-bottom: 20px; font-size: 0.9rem; transition: background 0.3s; }
        .notify-btn.urgent { background-color: #fee2e2; color: #991b1b; border-color: #fca5a5; animation: pulseBtn 2s infinite; }
        @keyframes pulseBtn { 0% { opacity: 1; } 50% { opacity: 0.8; } 100% { opacity: 1; } }

        .whatsapp-btn { width: 100%; background-color: var(--whatsapp); color: white; border: none; padding: 16px; font-size: 1rem; border-radius: 12px; margin-bottom: 40px; cursor: pointer; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; box-shadow: 0 4px 12px rgba(37, 211, 102, 0.3); display: none; align-items: center; justify-content: center; gap: 10px; }

        .log-container { margin-top: 30px; background: #f1f5f9; border-radius: 12px; padding: 15px; border: 1px solid #e2e8f0; max-height: 150px; overflow-y: auto; }
        .log-entry { font-size: 0.75rem; padding: 4px 0; border-bottom: 1px solid #e2e8f0; color: #475569; display: flex; justify-content: space-between; }
        .log-entry:last-child { border-bottom: none; }
        .log-time { font-size: 0.7rem; color: #94a3b8; }

        .teams-container { display: flex; flex-direction: column; gap: 20px; padding-bottom: 40px; margin-top: 20px; }
        .team-card { background: white; border-radius: 12px; overflow: hidden; box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1); border: 1px solid #e2e8f0; }
        .team-header { padding: 15px; text-align: center; font-size: 1.1rem; font-weight: 800; text-transform: uppercase; letter-spacing: 1px; }
        .team-list li { padding: 10px 20px; border-bottom: 1px solid #f1f5f9; font-size: 1rem; color: #334155; display: flex; align-items: center; }
        .team-list li:last-child { border-bottom: none; }
        .team-list li::before { content: ''; display: inline-block; width: 6px; height: 6px; border-radius: 50%; background-color: #cbd5e1; margin-right: 12px; }
        .team-blanco .team-header { background: #ffffff; color: #1e293b; border-bottom: 2px solid #cbd5e1; }
        .team-blanco { border: 2px solid #cbd5e1; }
        .team-negro .team-header { background: #1e293b; color: white; }
        .team-negro { border: 2px solid #1e293b; }
        .team-rojo .team-header { background: #ef4444; color: white; }
        .team-rojo { border: 2px solid #ef4444; }
        
        .loading-overlay { position: fixed; top:0; left:0; right:0; bottom:0; background: rgba(255,255,255,0.8); z-index: 200; display: flex; justify-content: center; align-items: center; font-weight: bold; }
        #time-lock-msg { text-align: center; color: #94a3b8; font-size: 0.75rem; margin-bottom: 20px; display: block; height: 20px; }
        #setup-panel { background: white; padding: 30px; border-radius: 16px; text-align: center; box-shadow: 0 4px 20px rgba(0,0,0,0.05); margin-top: 20px; }
        input[type="date"] { padding: 15px; font-size: 1.1rem; border: 2px solid #e2e8f0; border-radius: 8px; width: 100%; box-sizing: border-box; font-family: 'Montserrat', sans-serif; color: var(--brand-dark); margin-bottom: 20px; }
        
        @keyframes slideDown { from { transform: translateY(-20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @keyframes pulseTimer { 0% { opacity: 1; } 50% { opacity: 0.6; } 100% { opacity: 1; } }
        @keyframes blink { 0% { opacity: 1; } 50% { opacity: 0; } 100% { opacity: 1; } }
    </style>
</head>
<body>

<div id="loader" class="loading-overlay">Conectando...</div>

<header>
    <h1 onclick="secretAdminTap()">AMPA Futsal 25/26</h1>
    <div id="header-date" class="match-date-display"></div>
</header>

<div class="container">
    
    <div id="user-greeting"></div>

    <div id="admin-zone">
        <div style="color:#e11d48; font-weight:800; margin-bottom:10px;">ADMIN ZONE</div>
        
        <button class="admin-btn admin-btn-green" onclick="resetCurrentMatch()">üîÑ Reiniciar Partido (Nuevo D√≠a)</button>

        <div style="font-size:0.75rem; font-weight:bold; color:#334155; margin-bottom:5px; margin-top:10px; text-align:left;">üõ°Ô∏è Seguridad & Votaci√≥n:</div>
        <div style="display:flex; gap:5px;">
            <button id="pin-mode-btn" class="pin-toggle-btn" onclick="togglePinMode()">PIN...</button>
            <button id="vote-mode-btn" class="pin-toggle-btn" onclick="toggleVoteMode()">VOTO...</button>
        </div>

        <div style="font-size:0.75rem; font-weight:bold; color:#334155; margin-bottom:5px; text-align:left;">üïí Hora Creaci√≥n Equipos:</div>
        <div class="time-control">
            <input type="time" id="admin-time-input" value="18:00">
            <button class="admin-btn admin-btn-blue" style="margin:0" onclick="changeLockTime()">Actualizar</button>
        </div>

        <div style="font-size:0.75rem; font-weight:bold; color:#334155; margin-bottom:5px; text-align:left;">‚ûï Alta Nuevo Jugador:</div>
        <div class="new-player-form">
            <input type="text" id="new-player-name" placeholder="Nombre">
            <select id="new-player-level">
                <option value="1">Nivel 1</option>
                <option value="2" selected>Nivel 2</option>
                <option value="3">Nivel 3</option>
            </select>
            <button class="new-player-btn" onclick="addNewPlayer()">+</button>
        </div>

        <div style="font-size:0.7rem; color:#e11d48; font-weight:bold; margin-top:10px;">üö´ GESTI√ìN DE BAJAS (Bloquear/Desbloquear)</div>
        <div id="ban-list" class="chip-list">
            <div style="font-size:0.7rem; color:#999; width:100%;">Cargando...</div>
        </div>

        <div style="font-size:0.7rem; color:#e11d48; font-weight:bold; margin-top:10px;">üîê GESTI√ìN DE PINS (Reset Individual)</div>
        <div id="pin-list" class="chip-list">
            <div style="font-size:0.7rem; color:#999; width:100%;">Cargando...</div>
        </div>

        <button class="admin-btn admin-btn-yellow" onclick="voteToUnlock()">üôã Votar Desbloqueo (Yo)</button>
        <button class="admin-btn admin-btn-blue" onclick="forceGeneration()">‚ö° Forzar Creaci√≥n Ya</button>
        <button class="admin-btn" onclick="undoTeams()">üîô Deshacer Equipos</button>
        <button class="admin-btn" style="margin-top:15px;" onclick="forceReset()">üî• Borrado TOTAL (Reset App)</button>
        
        <div style="margin-top:10px; font-size:0.7rem; cursor:pointer; text-decoration:underline" onclick="hideAdmin()">Cerrar</div>
    </div>

    <div id="setup-panel" style="display:none;">
        <h2 style="margin-top:0; color:var(--brand-dark)">‚öΩ Nuevo Partido</h2>
        <p style="color:#64748b; margin-bottom:20px;">Elige la fecha para abrir la convocatoria:</p>
        <input type="date" id="date-input">
        <button class="action-btn" onclick="startNewMatch()">ABRIR CONVOCATORIA</button>
        
        <div class="install-center">
            <button class="install-app-btn" onclick="installApp()">üì≤ Instalar App</button>
        </div>
    </div>

    <div id="active-match-panel" style="display:none;">
        <button id="notify-btn" class="notify-btn" onclick="shareConvocation()">üì¢ Reenviar aviso al Grupo</button>

        <div class="status-bar">
            <div class="status-header">
                <div>
                    <span class="status-label">CONVOCADOS</span>
                    <span class="status-sub" id="status-text">M√°x 18</span>
                </div>
                <span class="status-count" id="player-count">0 / 18</span>
            </div>
            <div class="progress-track">
                <div id="progress-fill" class="progress-fill"></div>
            </div>
            <div id="countdown-display" class="countdown-text"></div>
        </div>
        
        <div id="selection-phase">
            <div class="install-center">
                <button class="install-app-btn" onclick="installApp()">üì≤ Instalar App</button>
            </div>

            <h3>PLANTILLA</h3>
            <div class="player-group" id="player-container"></div>

            <h3>Invitados</h3>
            <div class="player-group" id="guest-container"></div>

            <div class="log-container">
                <div class="log-title">üïì Historial de Actividad</div>
                <div id="activity-log"></div>
            </div>

            <button id="vote-btn" class="vote-btn" onclick="voteToUnlock()">üîì Solicitar Desbloqueo Anticipado (0/3)</button>

            <button id="btn-create" class="action-btn" onclick="attemptGeneration()">CREAR EQUIPOS</button>
            <span id="time-lock-msg" class="time-lock-msg"></span>
        </div>

        <div id="results-phase" style="display:none;">
            
            <div class="game-controls">
                <div style="font-size:0.8rem; font-weight:bold; margin-bottom:5px; color:#94a3b8;">TIEMPO DE JUEGO</div>
                <div class="timer-status-text" id="timer-status-text"></div>
                <div id="timer-display" class="timer-display">05:00</div>
                <div class="timer-btn-row">
                    <button class="t-btn t-start" onclick="toggleTimer()" id="timer-start-btn">‚ñ∂ INICIO</button>
                    <button class="t-btn t-reset" onclick="resetTimer()">‚Ü∫ RESET</button>
                </div>

                <div id="scoreboard" class="scoreboard" style="display:none;">
                    <div class="score-box">
                        <span class="score-team sb-blanco">BLANCO</span>
                        <span id="sc-blanco" class="score-val">0</span>
                        <div>
                            <button class="score-btn" onclick="updateScore(0, 1)">+</button>
                            <button class="score-btn" onclick="updateScore(0, -1)">-</button>
                        </div>
                    </div>
                    <div class="score-box">
                        <span class="score-team sb-negro">NEGRO</span>
                        <span id="sc-negro" class="score-val">0</span>
                        <div>
                            <button class="score-btn" onclick="updateScore(1, 1)">+</button>
                            <button class="score-btn" onclick="updateScore(1, -1)">-</button>
                        </div>
                    </div>
                    <div class="score-box">
                        <span class="score-team sb-rojo">ROJO</span>
                        <span id="sc-rojo" class="score-val">0</span>
                        <div>
                            <button class="score-btn" onclick="updateScore(2, 1)">+</button>
                            <button class="score-btn" onclick="updateScore(2, -1)">-</button>
                        </div>
                    </div>
                </div>
            </div>

            <h3 style="text-align: center; color: #2563eb;">¬°EQUIPOS CONFIRMADOS!</h3>
            
            <div class="match-info-card">
                <div id="res-date" class="res-date"></div>
                <div class="res-time">‚è∞ 20:30h</div>
                <div class="res-location">üìç Pabell√≥n Colegio Virgen de la Vega, Benavente</div>
            </div>

            <div class="teams-container" id="teams-result"></div>
            <button class="whatsapp-btn" style="display:flex" onclick="shareTeamsOnWhatsapp()">
                üì≤ Enviar Equipos al Grupo
            </button>
        </div>
    </div>
</div>

<script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-app.js";
    import { getFirestore, doc, onSnapshot, setDoc, updateDoc, arrayUnion } from "https://www.gstatic.com/firebasejs/10.7.1/firebase-firestore.js";

    // -------------------------------------------------------------
    // ‚ö†Ô∏è PEGA AQU√ç TUS CLAVES DE FIREBASE ‚ö†Ô∏è
    // -------------------------------------------------------------
const firebaseConfig = {
  apiKey: "AIzaSyAVTxYarB7cZzrZcm2ns5DaDsRgf2VaDpA",
  authDomain: "ampa-test-fff41.firebaseapp.com",
  projectId: "ampa-test-fff41",
  storageBucket: "ampa-test-fff41.firebasestorage.app",
  messagingSenderId: "966954997542",
  appId: "1:966954997542:web:0db03a4a88d14ac96453e7"
};
    // -------------------------------------------------------------

    const ADMIN_PIN = "9386";

    let app, db, matchRef;
    try {
        app = initializeApp(firebaseConfig);
        db = getFirestore(app);
        matchRef = doc(db, "partidos", "semana_actual"); 
    } catch (e) { console.error(e); }

    // JUGADORES INICIALES (Fallback)
    const initialPlayers = [
        { name: "Willi", level: 3 }, { name: "Jhon", level: 3 }, { name: "Santi", level: 3 },
        { name: "Ivan", level: 3 }, { name: "Gus", level: 3 }, { name: "Fabi√°n", level: 3 },
        { name: "Arturo", level: 3 }, { name: "Abraham", level: 2 }, { name: "Iv√°n N", level: 2 },
        { name: "Adri√°n", level: 2 }, { name: "Yusto", level: 2 }, { name: "Jos√©", level: 2 },
        { name: "To√±o", level: 2 }, { name: "Rafa", level: 2 }, { name: "Edu", level: 2 },
        { name: "Jes√∫s S", level: 1 }, { name: "Norvey", level: 1 }, { name: "Richard", level: 1 },
        { name: "Rub√©n", level: 1 }, { name: "Eloy", level: 1 }, { name: "Luis", level: 1 },
        { name: "Alfredo", level: 1 }
    ];

    const guestsDB = [
        { name: "Invitado 1" }, { name: "Invitado 2" }, { name: "Invitado 3" }, 
        { name: "Invitado 4" }, { name: "Invitado 5" }
    ];

    let currentData = { 
        matchDate: null, 
        lockTime: "18:00", 
        pinMode: true, 
        voteMode: true,
        selectedPlayers: [], 
        selectedGuests: [], 
        bannedIndices: [], 
        guestInviters: {}, 
        teams: null, 
        logs: [], 
        pins: {}, 
        unlockVotes: [],
        roster: [],
        scores: [0,0,0],
        timerState: 'stopped', timerEnd: 0, timerLeft: 300
    };
    const MAX_PLAYERS = 18;
    let timerInterval = null;
    let isTimerRunning = false;
    let hasBeeped = false; // Bandera para sonido √∫nico

    // --- INICIALIZACI√ìN ---
    document.getElementById('date-input').valueAsDate = new Date();

    const mySavedIndex = localStorage.getItem('futsal_my_index');
    const mySavedType = localStorage.getItem('futsal_my_type');
    
    // --- LOGICA PWA ---
    let deferredPrompt;
    window.addEventListener('beforeinstallprompt', (e) => {
        e.preventDefault();
        deferredPrompt = e;
    });
    window.installApp = async () => {
        if (deferredPrompt) {
            deferredPrompt.prompt();
            const { outcome } = await deferredPrompt.userChoice;
            deferredPrompt = null;
        } else {
            alert("‚ÑπÔ∏è PARA INSTALAR:\n\nü§ñ Android: Men√∫ (3 puntos) -> 'Instalar aplicaci√≥n'.\n\nüçé iPhone: Bot√≥n Compartir -> 'A√±adir a pantalla de inicio'.");
        }
    };

    // --- LOGICA SELECCI√ìN ---
    window.toggleSelection = async (type, index, name) => {
        if (type === 'player' && currentData.bannedIndices && currentData.bannedIndices.includes(index)) {
            return alert("‚õî Este jugador est√° bloqueado temporalmente.");
        }

        let newPlayers = [...(currentData.selectedPlayers || [])];
        let newGuests = [...(currentData.selectedGuests || [])];
        let currentPins = {...(currentData.pins || {})};
        let newGuestInviters = {...(currentData.guestInviters || {})};
        
        const now = new Date();
        const timeStr = now.toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });
        let logAction = "";
        const pinKey = `${type}-${index}`;

        let inviterName = "";
        if (type === 'guest') {
            const userIndex = localStorage.getItem('futsal_my_index');
            const userType = localStorage.getItem('futsal_my_type');
            if (!userIndex || userType !== 'player' || !newPlayers.includes(parseInt(userIndex))) {
                return alert("‚õî Solo los jugadores confirmados (en verde) pueden traer invitados.");
            }
            const roster = currentData.roster || initialPlayers;
            if(roster[userIndex]) inviterName = roster[userIndex].name;
        }

        // SEGURIDAD PIN
        if (type === 'player' && currentData.pinMode !== false) { 
            if (currentPins[pinKey]) {
                const enteredPin = prompt(`üîí ${name} est√° protegido.\nIntroduce PIN:`);
                if (enteredPin !== currentPins[pinKey]) return alert("‚õî PIN Incorrecto.");
            } else {
                const newPin = prompt(`üõ°Ô∏è SEGURIDAD\nCrea un PIN de 4 n√∫meros para ${name}:`);
                if (!newPin || newPin.length < 3) return alert("Pon un PIN para seguridad.");
                currentPins[pinKey] = newPin;
            }
        }

        if (type === 'player') {
            if (newPlayers.includes(index)) {
                if(!confirm(`¬øConfirmas salida de ${name}?`)) return;
                newPlayers = newPlayers.filter(i => i !== index);
                logAction = `‚ùå ${name} sale`;
            } else {
                if ((newPlayers.length + newGuests.length) >= MAX_PLAYERS) return alert("‚õî CUPOS COMPLETOS (M√°x 18). Espera.");
                if(!confirm(`¬øConfirmas asistencia para ${name}?`)) return;
                
                newPlayers.push(index);
                logAction = `‚úÖ ${name} entra`;
                localStorage.setItem('futsal_my_index', index);
                localStorage.setItem('futsal_my_type', 'player');
            }
        } else {
            if (newGuests.includes(index)) {
                if(!confirm(`¬øBorrar a ${name}?`)) return;
                newGuests = newGuests.filter(i => i !== index);
                delete newGuestInviters[index]; 
                logAction = `‚ùå ${name} sale (invitado por ${inviterName})`;
            } else {
                if ((newPlayers.length + newGuests.length) >= MAX_PLAYERS) return alert("‚õî CUPOS COMPLETOS (M√°x 18). Espera.");
                if(!confirm(`¬øA√±adir invitado?`)) return;
                newGuests.push(index);
                newGuestInviters[index] = inviterName; 
                logAction = `‚úÖ ${name} invitado (por ${inviterName})`;
            }
        }

        await updateDoc(matchRef, { 
            selectedPlayers: newPlayers, 
            selectedGuests: newGuests,
            guestInviters: newGuestInviters,
            pins: currentPins,
            logs: arrayUnion(`${logAction}|${timeStr}`) 
        });
    };

    window.voteToUnlock = async () => {
        const myIdx = localStorage.getItem('futsal_my_index');
        if (!myIdx) return alert("Solo jugadores apuntados.");
        if (!currentData.selectedPlayers.includes(parseInt(myIdx))) return alert("Debes estar convocado.");
        if (currentData.unlockVotes && currentData.unlockVotes.includes(parseInt(myIdx))) return alert("Ya has votado.");
        if(confirm("¬øVotas para desbloquear YA?")) await updateDoc(matchRef, { unlockVotes: arrayUnion(parseInt(myIdx)) });
    };

    window.togglePinMode = async () => {
        const newState = currentData.pinMode === false ? true : false;
        if(confirm(`¬øCambiar seguridad PIN a ${newState ? 'ACTIVADO' : 'DESACTIVADO'}?`)) await updateDoc(matchRef, { pinMode: newState });
    }
    window.toggleVoteMode = async () => {
        const newState = currentData.voteMode === false ? true : false;
        if(confirm(`¬ø${newState ? 'ACTIVAR' : 'DESACTIVAR'} votaci√≥n?`)) await updateDoc(matchRef, { voteMode: newState });
    }

    window.togglePlayerBan = async (index, name) => {
        let currentBans = [...(currentData.bannedIndices || [])];
        if (currentBans.includes(index)) {
            currentBans = currentBans.filter(i => i !== index);
            if(!confirm(`¬øDesbloquear a ${name}?`)) return;
        } else {
            currentBans.push(index);
            if(!confirm(`¬øBLOQUEAR a ${name}?`)) return;
            if (currentData.selectedPlayers.includes(index)) {
                const newSelected = currentData.selectedPlayers.filter(i => i !== index);
                await updateDoc(matchRef, { selectedPlayers: newSelected });
            }
        }
        await updateDoc(matchRef, { bannedIndices: currentBans });
    };

    // --- TIMER LOGIC (SYNC) ---
    window.toggleTimer = async () => {
        if (currentData.timerState === 'running') {
            // PAUSA: Calculamos restante y guardamos
            const left = Math.max(0, Math.floor((currentData.timerEnd - Date.now()) / 1000));
            await updateDoc(matchRef, { timerState: 'paused', timerLeft: left });
        } else {
            // INICIO: Calculamos fin y guardamos
            const target = Date.now() + (currentData.timerLeft * 1000);
            await updateDoc(matchRef, { timerState: 'running', timerEnd: target });
        }
    };

    window.resetTimer = async () => {
        await updateDoc(matchRef, { timerState: 'stopped', timerLeft: 300 });
    };

    // --- SCOREBOARD ---
    window.updateScore = async (teamIndex, delta) => {
        let newScores = [...(currentData.scores || [0,0,0])];
        newScores[teamIndex] = Math.max(0, newScores[teamIndex] + delta);
        await updateDoc(matchRef, { scores: newScores });
    };

    onSnapshot(matchRef, (docSnap) => {
        document.getElementById('loader').style.display = 'none';
        if (docSnap.exists()) {
            currentData = docSnap.data();
            if (!currentData.roster || currentData.roster.length === 0) {
                initialPlayers.sort((a, b) => a.name.localeCompare(b.name));
                updateDoc(matchRef, { roster: initialPlayers });
            }
            updateUI(currentData);
        } else {
            initialPlayers.sort((a, b) => a.name.localeCompare(b.name));
            setDoc(matchRef, { 
                matchDate: null, lockTime: "18:00", pinMode: true, voteMode: true,
                selectedPlayers: [], selectedGuests: [], bannedIndices: [], guestInviters: {}, 
                teams: null, logs: [], pins: {}, unlockVotes: [],
                scores: [0,0,0], timerState: 'stopped', timerLeft: 300,
                roster: initialPlayers 
            });
        }
    });
    
    // TIMER LOCAL LOOP
    setInterval(() => {
        if(currentData.matchDate) checkTimeLock(currentData.matchDate, currentData.lockTime);

        // CHECK AUTO RESET (10:00 AM NEXT DAY)
        if (currentData.matchDate) {
            const matchDate = new Date(currentData.matchDate);
            const now = new Date();
            const resetTime = new Date(matchDate);
            resetTime.setDate(resetTime.getDate() + 1); // D√≠a siguiente
            resetTime.setHours(10, 0, 0, 0); // 10:00 AM
            if (now >= resetTime) resetCurrentMatch(true); // Force reset
        }
        
        // UPDATE CRONO DISPLAY
        const display = document.getElementById('timer-display');
        const btn = document.getElementById('timer-start-btn');
        const statusText = document.getElementById('timer-status-text');
        
        if(currentData.timerState === 'running') {
            // Calculate time left based on server target time
            const left = Math.max(0, Math.ceil((currentData.timerEnd - Date.now()) / 1000));
            const m = Math.floor(left / 60).toString().padStart(2, '0');
            const s = (left % 60).toString().padStart(2, '0');
            display.innerText = `${m}:${s}`;
            
            btn.innerText = "‚è∏ PAUSA";
            btn.className = "t-btn t-stop";
            
            if(left <= 60 && left > 0) {
                display.classList.add('last-minute');
                statusText.innerText = "¬°√öLTIMO MINUTO!";
            } else if (left <= 0) {
                display.classList.remove('last-minute');
                display.classList.add('finished');
                display.innerText = "√öLTIMA JUGADA";
                statusText.innerText = "TIEMPO CUMPLIDO";
                btn.innerText = "FIN";
                
                // Play sound ONCE
                if (!hasBeeped) {
                    const context = new (window.AudioContext || window.webkitAudioContext)();
                    const osc = context.createOscillator();
                    osc.type = 'sine'; osc.frequency.value = 800; osc.connect(context.destination);
                    osc.start(); setTimeout(() => osc.stop(), 1500);
                    hasBeeped = true;
                }
            } else {
                display.classList.remove('last-minute', 'finished');
                statusText.innerText = "";
                hasBeeped = false;
            }
        } else {
            // Paused or Stopped
            const m = Math.floor(currentData.timerLeft / 60).toString().padStart(2, '0');
            const s = (currentData.timerLeft % 60).toString().padStart(2, '0');
            display.innerText = `${m}:${s}`;
            btn.innerText = "‚ñ∂ INICIO";
            btn.className = "t-btn t-start";
            display.classList.remove('last-minute', 'finished');
            statusText.innerText = currentData.timerState === 'paused' ? "PAUSADO" : "";
            hasBeeped = false;
        }

    }, 500);

    function updateUI(data) {
        // ADMIN BUTTONS
        const pinBtn = document.getElementById('pin-mode-btn');
        if (data.pinMode !== false) { pinBtn.innerText = "üü¢ PIN ACTIVADO (Seguro)"; pinBtn.className = "pin-toggle-btn pin-on"; } 
        else { pinBtn.innerText = "üî¥ PIN DESACTIVADO (Libre)"; pinBtn.className = "pin-toggle-btn pin-off"; }

        const voteAdminBtn = document.getElementById('vote-mode-btn');
        if (data.voteMode !== false) { voteAdminBtn.innerText = "üü¢ VOTACI√ìN ACTIVA"; voteAdminBtn.className = "pin-toggle-btn pin-on"; } 
        else { voteAdminBtn.innerText = "üî¥ VOTACI√ìN DESACTIVADA"; voteAdminBtn.className = "pin-toggle-btn pin-off"; }

        const activeRoster = data.roster || initialPlayers;
        const container = document.getElementById('player-container');
        const guestContainer = document.getElementById('guest-container');
        
        container.innerHTML = '';
        guestContainer.innerHTML = '';

        if (mySavedIndex !== null && mySavedType === 'player' && activeRoster[mySavedIndex]) {
            const pName = activeRoster[mySavedIndex].name;
            document.getElementById('user-greeting').innerText = `üëã ¬°Hola, ${pName}!`;
            document.getElementById('user-greeting').style.display = 'block';
        }

        // RENDER PLAYERS
        activeRoster.forEach((p, idx) => {
            const div = document.createElement('div');
            div.className = 'player-checkbox';
            if (mySavedType === 'player' && parseInt(mySavedIndex) === idx) div.classList.add('is-me');
            div.id = `p-${idx}`;
            
            const isSelected = data.selectedPlayers?.includes(idx);
            const isBanned = data.bannedIndices?.includes(idx);
            const pins = data.pins || {};
            const key = `player-${idx}`;
            const lockIcon = (data.pinMode !== false && pins[key]) ? '<span class="lock-icon">üîí</span>' : '';
            const badgeContent = isSelected ? (data.selectedPlayers.indexOf(idx) + 1) : '';
            
            if(isSelected) div.classList.add('selected');
            if(isBanned) div.classList.add('banned');
            
            div.innerHTML = `<span class="order-badge" id="badge-p-${idx}">${badgeContent}</span> ${p.name} ${lockIcon}`;
            if (!isBanned) div.onclick = () => window.toggleSelection('player', idx, p.name);
            container.appendChild(div);
        });

        guestsDB.forEach((g, idx) => {
            const div = document.createElement('div');
            div.className = 'player-checkbox guest-label';
            div.id = `g-${idx}`;
            const isSelected = data.selectedGuests?.includes(idx);
            const inviter = (data.guestInviters && data.guestInviters[idx]) ? data.guestInviters[idx] : null;
            const pins = data.pins || {};
            const key = `guest-${idx}`;
            const lockIcon = (data.pinMode !== false && pins[key]) ? '<span class="lock-icon">üîí</span>' : '';
            if(isSelected) { div.classList.add('selected'); }
            const badgeContent = isSelected ? 'G' : '';
            let html = `<div class="guest-name"><span class="order-badge" id="badge-g-${idx}">${badgeContent}</span> ${g.name} ${lockIcon}</div>`;
            if (isSelected && inviter) { html += `<div class="invited-by">‚Ü≥ por ${inviter}</div>`; }
            div.innerHTML = html;
            div.onclick = () => window.toggleSelection('guest', idx, g.name);
            guestContainer.appendChild(div);
        });

        const setupPanel = document.getElementById('setup-panel');
        const activePanel = document.getElementById('active-match-panel');
        const headerDate = document.getElementById('header-date');
        const notifyBtn = document.getElementById('notify-btn');

        if (!data.matchDate) {
            setupPanel.style.display = 'block'; activePanel.style.display = 'none';
            headerDate.innerText = "PR√ìXIMO PARTIDO";
            return;
        }

        setupPanel.style.display = 'none'; activePanel.style.display = 'block';
        const dateObj = new Date(data.matchDate);
        headerDate.innerText = dateObj.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        
        document.getElementById('res-date').innerText = headerDate.innerText;
        document.getElementById('admin-time-input').value = data.lockTime || "18:00";

        const total = (data.selectedPlayers?.length || 0) + (data.selectedGuests?.length || 0);
        document.getElementById('player-count').innerText = `${total} / 18`;
        
        const bar = document.getElementById('progress-fill');
        const percentage = Math.min((total / MAX_PLAYERS) * 100, 100);
        bar.style.width = `${percentage}%`;
        if(total < 8) bar.style.backgroundColor = "#ef4444";
        else if (total < 12) bar.style.backgroundColor = "#eab308";
        else bar.style.backgroundColor = "#22c55e";

        const votes = data.unlockVotes ? data.unlockVotes.length : 0;
        const voteBtn = document.getElementById('vote-btn');
        if (!data.teams && total >= 8 && data.voteMode !== false) {
             voteBtn.style.display = 'block';
             voteBtn.innerText = `üîì Solicitar Desbloqueo Anticipado (${votes}/3)`;
             if (votes >= 3) {
                 voteBtn.style.backgroundColor = "#22c55e"; voteBtn.style.color = "white"; voteBtn.innerText = "‚úÖ Aprobado por Consenso"; voteBtn.disabled = true;
             }
        } else voteBtn.style.display = 'none';

        // ADMIN LISTS
        const pins = data.pins || {};
        const pinListDiv = document.getElementById('pin-list');
        const banListDiv = document.getElementById('ban-list');
        pinListDiv.innerHTML = ""; banListDiv.innerHTML = ""; 
        
        activeRoster.forEach((p, idx) => {
            const isBanned = data.bannedIndices?.includes(idx);
            const banClass = isBanned ? 'chip-ban is-banned' : 'chip-ban';
            const banText = isBanned ? `üîì Desbloquear ${p.name}` : `üö´ Bloquear ${p.name}`;
            banListDiv.innerHTML += `<div class="chip ${banClass}" onclick="togglePlayerBan(${idx}, '${p.name}')">${banText}</div>`;
        });

        Object.keys(pins).forEach(key => {
            let name = "??";
            const [type, idxStr] = key.split('-');
            const idx = parseInt(idxStr);
            if(type === 'player' && activeRoster[idx]) name = activeRoster[idx].name;
            pinListDiv.innerHTML += `<div class="chip chip-reset" onclick="resetSinglePin('${key}', '${name}')">üîê Reset ${name}</div>`;
        });
        if(pinListDiv.innerHTML === "") pinListDiv.innerHTML = `<div style="font-size:0.7rem; color:#999; width:100%;">Sin contrase√±as</div>`;

        // LOGS
        const logDiv = document.getElementById('activity-log');
        if (data.logs && data.logs.length > 0) {
            logDiv.innerHTML = "";
            [...data.logs].reverse().slice(0, 15).forEach(logStr => {
                const parts = logStr.split('|');
                if(parts.length === 2) logDiv.innerHTML += `<div class="log-entry"><span>${parts[0]}</span><span style="color:#94a3b8;font-size:0.7em">${parts[1]}</span></div>`;
            });
        } else logDiv.innerHTML = `<div style="text-align:center; color:#ccc; font-size:0.8rem">Sin actividad</div>`;

        let teamsData = data.teams;
        if (typeof teamsData === 'string') { try { teamsData = JSON.parse(teamsData); } catch(e){} }

        if (teamsData && teamsData.length > 0) {
            document.getElementById('selection-phase').style.display = 'none';
            document.getElementById('results-phase').style.display = 'block';
            notifyBtn.style.display = 'none';
            
            if(teamsData.length === 3) document.getElementById('scoreboard').style.display = 'flex';
            else document.getElementById('scoreboard').style.display = 'none';

            renderTeams(teamsData);
        } else {
            document.getElementById('selection-phase').style.display = 'block';
            document.getElementById('results-phase').style.display = 'none';
            notifyBtn.style.display = 'flex';
            checkTimeLock(data.matchDate, data.lockTime);
        }
    }

    function checkTimeLock(matchDateString, lockTimeString) {
        const btnCreate = document.getElementById('btn-create');
        const msg = document.getElementById('time-lock-msg');
        const notifyBtn = document.getElementById('notify-btn');
        const countdownDiv = document.getElementById('countdown-display');
        
        const now = new Date();
        const targetTime = new Date(matchDateString);
        const [hours, minutes] = (lockTimeString || "18:00").split(':');
        targetTime.setHours(hours, minutes, 0, 0);
        
        if (now < targetTime) {
            const diff = targetTime - now;
            const h = Math.floor(diff / (1000 * 60 * 60));
            const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
            const s = Math.floor((diff % (1000 * 60)) / 1000);
            countdownDiv.innerText = `Cierre en: ${h}h ${m}m ${s}s`;
        } else countdownDiv.innerText = "Cierre alcanzado";

        const urgentTime = new Date(targetTime);
        urgentTime.setMinutes(targetTime.getMinutes() - 45);
        const total = (currentData.selectedPlayers?.length || 0) + (currentData.selectedGuests?.length || 0);

        if (now >= urgentTime && now < targetTime && total < 10) {
            const missing = 10 - total;
            notifyBtn.innerHTML = `‚ö†Ô∏è URGENTE: FALTAN ${missing}`;
            notifyBtn.classList.add('urgent');
            notifyBtn.onclick = () => sharePanic(missing);
        } else {
            notifyBtn.innerHTML = "üì¢ Reenviar aviso al Grupo";
            notifyBtn.classList.remove('urgent');
            notifyBtn.onclick = () => shareConvocation();
        }

        const votes = currentData.unlockVotes ? currentData.unlockVotes.length : 0;
        
        if (now >= targetTime || votes >= 3) {
            btnCreate.disabled = false;
            btnCreate.innerHTML = "CREAR EQUIPOS";
            msg.innerText = "";
        } else {
            btnCreate.disabled = true;
            btnCreate.innerHTML = "üîí CREAR EQUIPOS";
            msg.innerText = `Disponible a las ${lockTimeString} (o con 3 votos)`;
        }
    }

    window.sharePanic = (missing) => {
        const appUrl = window.location.href;
        const lockTime = currentData.lockTime || "18:00";
        const text = `‚ö†Ô∏è *¬°ATENCI√ìN! CIERRE INMINENTE* ‚ö†Ô∏è\n\nFaltan *${missing} JUGADORES* para ser 10.\nCierre a las ${lockTime}h.\n\nüëá *AP√öNTATE YA:*\n${appUrl}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    };

    window.startNewMatch = async () => {
        const dateInput = document.getElementById('date-input').value;
        if (!dateInput) return alert("Selecciona fecha.");
        
        const selected = new Date(dateInput);
        const today = new Date();
        today.setHours(0,0,0,0);
        if(selected < today) return alert("Error: No puedes seleccionar un d√≠a pasado.");

        const myIdx = localStorage.getItem('futsal_my_index');
        const roster = currentData.roster || initialPlayers;
        const author = (myIdx && roster[myIdx]) ? roster[myIdx].name : "Admin";
        const now = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

        if(confirm("¬øConfirmar?")) {
            await setDoc(matchRef, { 
                matchDate: dateInput, 
                // KEEP PREVIOUS SETTINGS
                lockTime: currentData.lockTime || "18:00",
                pinMode: currentData.pinMode,
                voteMode: currentData.voteMode,
                selectedPlayers: [], selectedGuests: [], guestInviters: {}, 
                scores: [0,0,0], timerState: 'stopped', timerLeft: 300,
                teams: null, logs: [`üìÖ Convocatoria abierta por ${author}|${now}`], 
                pins: currentData.pins || {}, unlockVotes: [] 
            }, { merge: true });
            window.shareConvocation(dateInput);
        }
    };

    // REINICIAR SOLO PARTIDO (FORCE = TRUE IS AUTO)
    window.resetCurrentMatch = async (force = false) => {
        if(force || confirm("¬øEmpezar semana nueva? (Borra selecciones, mantiene jugadores)")) {
            await updateDoc(matchRef, { 
                matchDate: null, selectedPlayers: [], selectedGuests: [], guestInviters: {}, 
                teams: null, logs: [], scores: [0,0,0], timerState: 'stopped', unlockVotes: [] 
            });
            if(!force) window.hideAdmin();
        }
    };

    window.changeLockTime = async () => {
        const newTime = document.getElementById('admin-time-input').value;
        if(confirm(`¬øCambiar cierre a las ${newTime}?`)) {
            await updateDoc(matchRef, { lockTime: newTime });
            window.hideAdmin();
        }
    };

    window.addNewPlayer = async () => {
        const name = document.getElementById('new-player-name').value;
        const level = parseInt(document.getElementById('new-player-level').value);
        if(!name) return alert("Pon un nombre");
        if(confirm(`¬øA√±adir a ${name}?`)) {
            const newPlayer = { name: name, level: level };
            await updateDoc(matchRef, { roster: arrayUnion(newPlayer) });
            alert("Jugador a√±adido.");
            document.getElementById('new-player-name').value = '';
        }
    };

    window.shareConvocation = (optionalDate) => {
        let dateStr = "";
        const d = optionalDate ? new Date(optionalDate) : new Date(currentData.matchDate);
        dateStr = d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        const time = currentData.lockTime || "18:00";
        const appUrl = window.location.href;
        const text = `‚öΩ *CONVOCATORIA ABIERTA* ‚öΩ\n\nüìÖ Fecha: ${dateStr.toUpperCase()}\n‚è∞ Hora Cierre: ${time}h\n\nüëá *Ap√∫ntate aqu√≠:*\n${appUrl}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    };

    window.shareTeamsOnWhatsapp = () => {
        const teams = window.currentTeamsForCopy;
        if(!teams) return;
        const emojis = ['‚ö™', '‚ö´', 'üî¥'];
        const names = ['BLANCO', 'NEGRO', 'ROJO'];
        const d = new Date(currentData.matchDate);
        const dateStr = d.toLocaleDateString('es-ES', { weekday: 'long', day: 'numeric', month: 'long' });
        let text = `*‚öΩ EQUIPOS CONFIRMADOS ‚öΩ*\nüìÖ ${dateStr.toUpperCase()} - 20:30h\n`;
        text += `üìç Pabell√≥n Colegio Virgen de la Vega, Benavente\n\n`;
        
        teams.forEach((team, idx) => {
            text += `${emojis[idx]} *EQUIPO ${names[idx]}* (${team.length})\n`;
            team.forEach(p => text += `- ${p.name}\n`);
            text += "\n";
        });
        text += `üîó Ver en la web: ${window.location.href}`;
        window.open(`https://wa.me/?text=${encodeURIComponent(text)}`, '_blank');
    };

    window.attemptGeneration = () => {
        const targetTime = new Date(currentData.matchDate);
        const [hours, minutes] = (currentData.lockTime || "18:00").split(':');
        targetTime.setHours(hours, minutes, 0, 0);
        const votes = currentData.unlockVotes ? currentData.unlockVotes.length : 0;

        const canUnlockByVote = (currentData.voteMode !== false && votes >= 3);

        if (new Date() < targetTime && !canUnlockByVote) return alert(`Espera a las ${currentData.lockTime} o votad 3 personas.`);
        const total = (currentData.selectedPlayers?.length || 0) + (currentData.selectedGuests?.length || 0);
        if (total < 8) return alert("M√≠nimo 8.");
        if (total <= 12) triggerGeneration(2); else triggerGeneration(3);
    };

    window.triggerGeneration = async (numTeams) => {
        document.getElementById('loader').style.display = 'flex';
        const roster = currentData.roster || initialPlayers;
        const sPlayers = (currentData.selectedPlayers || []).map(i => roster[i]);
        const sGuests = (currentData.selectedGuests || []).map(i => ({...guestsDB[i], level: 0, isGuest: true}));
        let l3 = shuffle([...sPlayers.filter(p => p.level === 3)]);
        let l2 = shuffle([...sPlayers.filter(p => p.level === 2)]);
        let l1 = shuffle([...sPlayers.filter(p => p.level === 1)]);
        let lg = shuffle([...sGuests]);
        let pool = [...l3, ...l2, ...l1, ...lg];
        let teams = Array.from({ length: numTeams }, () => []);
        pool.forEach((player, i) => { teams[i % numTeams].push(player); });
        teams.forEach(t => shuffle(t));
        const teamsString = JSON.stringify(teams);
        
        const myIdx = localStorage.getItem('futsal_my_index');
        const author = (myIdx && roster[myIdx]) ? roster[myIdx].name : "Sistema";
        const now = new Date().toLocaleTimeString('es-ES', { hour: '2-digit', minute: '2-digit' });

        await updateDoc(matchRef, { 
            teams: teamsString,
            logs: arrayUnion(`‚öΩ Equipos generados por ${author}|${now}`)
        });
        document.getElementById('loader').style.display = 'none';
    };

    function shuffle(array) {
        for (let i = array.length - 1; i > 0; i--) {
            const j = Math.floor(Math.random() * (i + 1));
            [array[i], array[j]] = [array[j], array[i]];
        }
        return array;
    }

    function renderTeams(teams) {
        const resDiv = document.getElementById('teams-result');
        resDiv.innerHTML = '';
        const names = ['BLANCO', 'NEGRO', 'ROJO'];
        const classes = ['team-blanco', 'team-negro', 'team-rojo'];
        teams.forEach((team, idx) => {
            let html = `<div class="team-card ${classes[idx]}"><div class="team-header">EQUIPO ${names[idx]}</div><ul class="team-list">`;
            team.forEach(p => {
                const name = p.isGuest ? `<span class="guest-result">${p.name}</span>` : p.name;
                html += `<li>${name}</li>`;
            });
            html += `</ul></div>`;
            resDiv.innerHTML += html;
        });
        window.currentTeamsForCopy = teams;
    }

    // ADMIN
    let tapCount = 0; let tapTimer = null;
    window.secretAdminTap = () => {
        tapCount++; clearTimeout(tapTimer);
        tapTimer = setTimeout(() => { tapCount = 0; }, 2000);
        if (tapCount >= 5) {
            const entered = prompt("üîë PIN Admin:");
            if(entered === ADMIN_PIN) document.getElementById('admin-zone').style.display = 'block';
            else alert("Error");
            tapCount = 0;
        }
    };
    window.hideAdmin = () => document.getElementById('admin-zone').style.display = 'none';
    window.undoTeams = async () => confirm("¬øDeshacer?") && (await updateDoc(matchRef, { teams: null }), window.hideAdmin());
    
    // RESET TOTAL
    window.forceReset = async () => confirm("‚ö† PELIGRO: ESTO BORRA PINS Y TODO. ¬øSEGURO?") && (await setDoc(matchRef, { matchDate: null, lockTime: "18:00", pinMode: true, voteMode: true, selectedPlayers: [], selectedGuests: [], bannedIndices: [], guestInviters: {}, teams: null, logs: [], pins: {}, unlockVotes: [], scores:[0,0,0], roster: initialPlayers }), window.hideAdmin());
    
    window.forceGeneration = () => {
         const total = (currentData.selectedPlayers?.length || 0) + (currentData.selectedGuests?.length || 0);
         if (total < 8) return alert("M√≠nimo 8.");
         if(confirm("¬øForzar?")) { (total <= 12) ? triggerGeneration(2) : triggerGeneration(3); window.hideAdmin(); }
    };
    window.resetSinglePin = async (key, name) => {
        if(confirm(`¬øQuitar la contrase√±a a ${name}?`)) {
            const newPins = {...currentData.pins};
            delete newPins[key];
            await updateDoc(matchRef, { pins: newPins });
        }
    };
</script>
</body>
</html>